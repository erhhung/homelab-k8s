# openwebui_mcpo_api_key: {vault.yml}

mcpo_namespace: open-webui
mcpo_host_names: # aliases of "ingress"
  - mcpo
  - mcp

# remember to add mcpo.fourteeners.local and mcp. to pfSense
# DNS as aliases of ingress.fourteeners.local: 192.168.4.222
# https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_filters.html#products
mcpo_fqdns: "{{ mcpo_host_names | product(search_domains) | map('join','.') }}"

mcpo_service_host: "{{ mcpo_release_name }}.{{
  mcpo_namespace }}.svc.{{ cluster_domain }}"
mcpo_service_port: 8000
mcpo_service_url: http://{{ mcpo_service_host }}:{{ mcpo_service_port }}

mcpo_secrets:
  ingress: mcpo-ingress-tls
  api-key: mcpo-api-key

crawl4ai_image:
  pullPolicy: Always
  registry: "{{ harbor_container_registry }}"
  repository: library/mcp-crawl4ai
  # either specify a tag or, if registry is Harbor,
  # let Ansible task query the most recently pushed
  # tag, which is not necessarily the tag "latest"
  # tag: 89f0ae3d

# https://github.com/first-it-consulting/helm-mcpo
mcpo_chart_version: "0.2.7" # uses old mcpo image
mcpo_release_name: mcpo

# https://github.com/first-it-consulting/helm-mcpo/tree/main/values.yaml
mcpo_chart_values:
  replicaCount: 1

  image:
    # https://github.com/open-webui/mcpo/pkgs/container/mcpo/versions?filters%5Bversion_type%5D=tagged
    tag: git-91e8f94

  env:
    # /.npm is on read-only filesystem:
    # use writable cache volume instead
    NPM_CONFIG_CACHE: /.cache/npm
  envSecrets:
    MCPO_API_KEY: # referenced by container args
      secretName: "{{ mcpo_secrets['api-key'] }}"
      secretKey: MCPO_API_KEY

  podSecurityContext:
    fsGroup: 2000
  securityContext:
    capabilities:
      drop: ["ALL"]
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 1000

  resources:
    requests:
      cpu: 10m
      memory: 256Mi

  # NOT CURRENTLY USED BY CHART--rendered as patches instead:
  # https://github.com/first-it-consulting/helm-mcpo/issues/3
  extraArgs:
    # add --api-key to secure /openapi.json endpoint:
    # https://github.com/open-webui/mcpo#-quick-usage
    - --api-key
    - $(MCPO_API_KEY)

  # NOT CURRENTLY USED BY CHART
  # rendered as patches instead
  initContainers:
    # create named pipes for stdio-mode communication
    # between the main mcpo container and MCP servers
    # deployed as sidecar containers
    - name: stdio-pipes
      image: busybox
      imagePullPolicy: IfNotPresent
      command: ["sh"]
      args:
        - -c
        - |-
          set -ex
          cd /pipes
          chmod 777 .
          mkfifo -m 666 crawl4ai-stdin
          mkfifo -m 666 crawl4ai-stdout
          ls -la
      volumeMounts:
        - name: pipes
          mountPath: /pipes

  # NOT CURRENTLY USED BY CHART
  # rendered as patches instead
  extraContainers:
    - name: crawl4ai
      image: "{{ harbor_container_registry }}/{{ crawl4ai_image.repository }}:{{
        crawl4ai_image.tag | default(crawl4ai_image_tag | default('latest')) }}"
      imagePullPolicy: "{{ crawl4ai_image.pullPolicy | default('IfNotPresent') }}"
      command: ["sh"]
      args:
        - -c
        - |-
          set -e
          echo "Starting Crawl4AI MCP server using named pipes..."
          exec  python -m crawler_agent.mcp_server \
            < /pipes/crawl4ai-stdin \
            > /pipes/crawl4ai-stdout
      volumeMounts:
        - name: pipes
          mountPath: /pipes
        # use as `output_dir` for
        # `scrape`/`crawl*` tools
        - name: data
          mountPath: /out

  # NOT CURRENTLY USED BY CHART
  # rendered as patches instead
  extraVolumeMounts:
    - name: tls
      mountPath: /tls/ca.crt
      subPath: ca.crt
    - name: mcp
      mountPath: /opt/mcp
      readOnly: true
    - name: pipes
      mountPath: /pipes
    - name: cache
      mountPath: /.cache
    - name: data
      mountPath: /.local/share

  # NOT CURRENTLY USED BY CHART
  # rendered as patches instead
  extraVolumes:
    - name: tls
      secret:
        secretName: "{{ mcpo_secrets['ingress'] }}"
    # non-NPM-published MCP server packages
    - name: mcp
      nfs:
        server: qnap.{{ homelab_domain }}
        path: /k8s_data/mcp
    - name: pipes
      emptyDir:
        medium: Memory
    # writable $XDG_CACHE_HOME and $XDG_DATA_HOME:
    # https://docs.astral.sh/uv/reference/environment
    - name: cache
      emptyDir: {}
    - name: data
      emptyDir: {}

  ingress:
    enabled: true
    tls:
      - secretName: "{{ mcpo_secrets['ingress'] }}"
        hosts: "{{ mcpo_fqdns }}"
    className: "{{ rke_ingress_class }}"
    annotations:
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      nginx.ingress.kubernetes.io/backend-protocol: HTTP
      # redirect root domain to Swagger UI at /docs
      nginx.ingress.kubernetes.io/server-snippet: |
        location = / {
          return 308 $scheme://$host/docs;
        }
    hosts: "{{ mcpo_fqdns }}"
    path: /
    pathType: Prefix

  # https://github.com/open-webui/mcpo#-using-a-config-file
  config:
    mcpServers:
      # https://github.com/modelcontextprotocol/servers/tree/main/src/time
      time:
        command: uvx
        args:
          - mcp-server-time
          - --local-timezone={{ system_time_zone }}

      # https://github.com/modelcontextprotocol/servers/tree/main/src/memory
      memory:
        command: npx
        args:
          - -y
          - "@modelcontextprotocol/server-memory"

      # https://github.com/erhhung/mcp-crawl4ai
      # https://github.com/unclecode/crawl4ai
      browser:
        command: sh
        args:
          - -c
          - |-
            echo >&2 "Starting Crawl4AI MCP server stdio bridge..."
            cat   /pipes/crawl4ai-stdout &
            cat > /pipes/crawl4ai-stdin
            wait

      weather:
        command: npx
        args:
          - -y
          - --loglevel=error
          # this is a local package created by `npm
          # pack` and stored on a shared NFS volume
          - --package=/opt/mcp/weather-server.tgz
          - weather-server
        env:
          OPENWEATHER_API_KEY: "{{ openweather_api_key }}"

      # https://github.com/Koneisto/HomeAssistant-Light-MCP
      lights:
        command: npx
        args:
          - -y
          - ha-mcp-server
        env:
          HA_URL: https://home.{{ homelab_domain }}:8123
          HA_TOKEN: "{{ hass_access_token }}"
          # /tls/ca.crt from volume mount
          NODE_EXTRA_CA_CERTS: /tls/ca.crt

# each tool server corresponds to an MCP
# server, even if a single MCPO instance
# hosts multiple MCP servers
mcp_tool_servers:
  # https://github.com/modelcontextprotocol/servers/tree/main/src/time
  - &tool
    info:
      id: time
      name: Time Tool
      description: >-
        Provides time and timezone conversion capabilities
        by allowing models to get current time information
        and perform conversions using IANA timezone names,
        with automatic system timezone detection.
    type: openapi
    spec_type: url
    url: "{{ mcpo_service_url }}/time"
    path: openapi.json
    auth_type: bearer
    key: "{{ openwebui_mcpo_api_key }}"
    config:
      enable: true
      access_control:
        read:
          group_ids:
            # fact set by earlier task
            - "{{ family_group_id }}"

  # https://github.com/modelcontextprotocol/servers/tree/main/src/memory
  - <<: *tool
    info:
      id: memory
      name: Memory Tool
      description: >-
        Implements persistent memory using local knowledge
        graph, allowing Open WebUI to remember information
        about the user across chats.
    url: "{{ mcpo_service_url }}/memory"

  - <<: *tool
    info:
      id: browser
      name: Browser Tool
      description: >-
        Provides web browsing capabilities by scraping
        and crawling websites.
    url: "{{ mcpo_service_url }}/browser"

  - <<: *tool
    info:
      id: weather
      name: Weather Tool
      description: >-
        Get the current weather for a city
        (condition, temperature, humidity).
    url: "{{ mcpo_service_url }}/weather"

  # https://github.com/Koneisto/HomeAssistant-Light-MCP
  - <<: *tool
    info:
      id: lights
      name: Light Tool
      description: >-
        Control Home Assistant-connected lights and manage
        scenes (turn on/off, set brightness, change color).
    url: "{{ mcpo_service_url }}/lights"
