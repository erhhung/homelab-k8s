# openwebui_mcpo_api_key: {vault.yml}

mcpo_namespace: open-webui
mcpo_host_names: # aliases of "ingress"
  - mcpo
  - mcp

# remember to add mcpo.fourteeners.local and mcp. to pfSense
# DNS as aliases of ingress.fourteeners.local: 192.168.4.222
# https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_filters.html#products
mcpo_fqdns: "{{ mcpo_host_names | product(search_domains) | map('join','.') }}"

mcpo_service_host: "{{ mcpo_release_name }}.{{
  mcpo_namespace }}.svc.{{ cluster_domain }}"
mcpo_service_port: 8000
mcpo_service_url: http://{{ mcpo_service_host }}:{{ mcpo_service_port }}

mcpo_secrets:
  ingress: mcpo-ingress-tls
  api-key: mcpo-api-key

# https://github.com/first-it-consulting/helm-mcpo
mcpo_chart_version: "0.2.7" # uses old mcpo image
mcpo_release_name: mcpo

# https://github.com/first-it-consulting/helm-mcpo/tree/main/values.yaml
mcpo_chart_values:
  replicaCount: 1

  image:
    # https://github.com/open-webui/mcpo/pkgs/container/mcpo/versions?filters%5Bversion_type%5D=tagged
    tag: git-91e8f94

  env:
    # /.npm is on read-only filesystem:
    # use writable cache volume instead
    NPM_CONFIG_CACHE: /.cache/npm
  envSecrets:
    MCPO_API_KEY: # referenced by container args
      secretName: "{{ mcpo_secrets['api-key'] }}"
      secretKey: MCPO_API_KEY

  podSecurityContext:
    fsGroup: 2000
  securityContext:
    capabilities:
      drop: ["ALL"]
    readOnlyRootFilesystem: true
    runAsNonRoot: true
    runAsUser: 1000

  resources:
    requests:
      cpu: 10m
      memory: 256Mi

  # NOT CURRENTLY USED BY CHART--rendered as patches instead:
  # https://github.com/first-it-consulting/helm-mcpo/issues/3
  extraArgs:
    # add --api-key to secure /openapi.json endpoint:
    # https://github.com/open-webui/mcpo#-quick-usage
    - --api-key
    - $(MCPO_API_KEY)

  # NOT CURRENTLY USED BY CHART
  # rendered as patches instead
  extraVolumes:
    - name: tls
      secret:
        secretName: "{{ mcpo_secrets['ingress'] }}"
    # non-NPM-published MCP server packages
    - name: mcp
      nfs:
        server: qnap.{{ homelab_domain }}
        path: /k8s_data/mcp
    # writable $XDG_CACHE_HOME and $XDG_DATA_HOME:
    # https://docs.astral.sh/uv/reference/environment
    - name: cache
      emptyDir: {}
    - name: data
      emptyDir: {}

  # NOT CURRENTLY USED BY CHART
  # rendered as patches instead
  extraVolumeMounts:
    - name: tls
      mountPath: /tls/ca.crt
      subPath: ca.crt
    - name: mcp
      mountPath: /opt/mcp
      readOnly: true
    - name: cache
      mountPath: /.cache
    - name: data
      mountPath: /.local/share

  ingress:
    enabled: true
    tls:
      - secretName: "{{ mcpo_secrets['ingress'] }}"
        hosts: "{{ mcpo_fqdns }}"
    className: "{{ rke_ingress_class }}"
    annotations:
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
      nginx.ingress.kubernetes.io/backend-protocol: HTTP
      # redirect root domain to Swagger UI at /docs
      nginx.ingress.kubernetes.io/server-snippet: |
        location = / {
          return 308 $scheme://$host/docs;
        }
    hosts: "{{ mcpo_fqdns }}"
    path: /
    pathType: Prefix

  # https://github.com/open-webui/mcpo#-using-a-config-file
  config:
    mcpServers:
      # https://github.com/modelcontextprotocol/servers/tree/main/src/time
      time:
        command: uvx
        args:
          - mcp-server-time
          - --local-timezone={{ system_time_zone }}

      # https://github.com/modelcontextprotocol/servers/tree/main/src/memory
      memory:
        command: npx
        args:
          - -y
          - "@modelcontextprotocol/server-memory"

      weather:
        command: npx
        args:
          - -y
          - --loglevel=error
          # this is a local package created by `npm
          # pack` and stored on a shared NFS volume
          - --package=/opt/mcp/weather-server.tgz
          - weather-server
        env:
          OPENWEATHER_API_KEY: "{{ openweather_api_key }}"

      # https://github.com/Koneisto/HomeAssistant-Light-MCP
      lights:
        command: npx
        args:
          - -y
          - ha-mcp-server
        env:
          HA_URL: https://home.{{ homelab_domain }}:8123
          HA_TOKEN: "{{ hass_access_token }}"
          # /tls/ca.crt from volume mount
          NODE_EXTRA_CA_CERTS: /tls/ca.crt

# each tool server corresponds to an MCP
# server, even if a single MCPO instance
# hosts multiple MCP servers
mcp_tool_servers:
  # https://github.com/modelcontextprotocol/servers/tree/main/src/time
  - &tool
    info:
      id: time
      name: Time Server
      description: >-
        Provides time and timezone conversion capabilities
        by allowing models to get current time information
        and perform conversions using IANA timezone names,
        with automatic system timezone detection.
    type: openapi
    spec_type: url
    url: "{{ mcpo_service_url }}/time"
    path: openapi.json
    auth_type: bearer
    key: "{{ openwebui_mcpo_api_key }}"
    config:
      enable: true
      access_control:
        read:
          group_ids:
            # fact set by earlier task
            - "{{ family_group_id }}"

  # https://github.com/modelcontextprotocol/servers/tree/main/src/memory
  - <<: *tool
    info:
      id: memory
      name: Memory Server
      description: >-
        Implements persistent memory using local knowledge
        graph, allowing Open WebUI to remember information
        about the user across chats.
    url: "{{ mcpo_service_url }}/memory"

  - <<: *tool
    info:
      id: weather
      name: Weather Server
      description: >-
        Get the current weather for a city
        (condition, temperature, humidity).
    url: "{{ mcpo_service_url }}/weather"

  # https://github.com/Koneisto/HomeAssistant-Light-MCP
  - <<: *tool
    info:
      id: lights
      name: Lights Server
      description: >-
        Control Home Assistant-connected lights and manage
        scenes (turn on/off, set brightness, change color).
    url: "{{ mcpo_service_url }}/lights"
