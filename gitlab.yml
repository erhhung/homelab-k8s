# https://docs.gitlab.com/charts/installation
# https://docs.gitlab.com/charts/advanced
---
- name: Install GitLab CI/CD stack
  tags: install
  hosts: "{{ rke_control_plane_host }}"
  vars_files:
    - vars/basics.yml
    - vars/kubernetes.yml
    - vars/postgresql.yml
    - vars/storage.yml
    - vars/minio.yml
    - vars/monitoring.yml
    # gitlab_secrets_data.*
    - vars/gitlab.secrets.yml
    - vars/gitlab.yml
  vars: &vars
    # required kubernetes>=24.2 package only in user virtualenv
    ansible_python_interpreter: "{{ venv_python_interpreter }}"
    kubeconfig: "{{ rke_kubeconfig }}"
    secret_ns: "{{ gitlab_namespace }}"
    create_ns: false
  pre_tasks:
    - name: Get the PostgreSQL image used
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_tasks_module.html
      ansible.builtin.include_tasks: tasks/postgresql/image.yml
      when: postgresql_image is undefined

    - name: Get CA certificates from PKI
      ansible.builtin.include_tasks: tasks/pki/cacerts.yml
      when: ca_certificates is undefined

    - name: Get current runner replicas
      # https://docs.ansible.com/ansible/latest/collections/kubernetes/core/k8s_info_module.html
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: apps/v1
        kind: Deployment
        name: "{{ gitlab_release_name }}-gitlab-runner"
        namespace: "{{ gitlab_namespace }}"
      register: runner_info

    - name: Set runner_replicas fact
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/set_fact_module.html
      ansible.builtin.set_fact:
        runner_replicas: >-
          {{ runner_info.resources[0].spec.replicas if
             runner_info.resources is truthy else 0 }}
  tasks:
    # cert also used by GitLab ingress
    - name: Create GitLab node secret
      vars:
        praefect: "{{ gitlab_chart_values.global.praefect }}"
        gitaly: gitaly-{{ praefect.virtualStorages[0].name }}
        services:
          - praefect
          - "{{ gitaly }}"
        svc_domains:
          - "{{ gitlab_namespace }}.svc.{{ cluster_domain }}"
          - "{{ gitlab_namespace }}.svc"
        secret_name: "{{ gitlab_secrets['node-tls'] }}"
        create_ns: true
        cert_name: gitlab-node
        sans_:
          - gitlab-node
          - "{{ gitlab_fqdns.values() }}"
          - "*.{{ gitlab_fqdns['pages'] }}"
          # include SANs for service pods
          - |
            {% set pods = [] %}
            {% for svc in services %}
            {%   set svc = gitlab_release_name ~'-'~ svc %}
            {%   set  _  = pods.append('*.'~ svc) %}
            {% endfor %}
            {{   pods | product(svc_domains) | map('join','.') }}
          - "{{ ['*'] | product(svc_domains) | map('join','.') }}"
          # workhorse to webservice
          - localhost
        sans: "{{ sans_ | flatten }}"
      ansible.builtin.include_tasks: tasks/k8s/secrets/tls.step.yml

    # https://docs.gitlab.com/runner/install/kubernetes_helm_chart_configuration#access-gitlab-with-a-custom-certificate
    - name: Create GitLab certs secret
      vars:
        domains:
          # include both external FQDN
          # and internal service domain
          - "{{ gitlab_fqdns['gitlab'] }}"
          - "{{ gitlab_service_host    }}"
          - "{{ gitlab_service_host | replace('.'~ cluster_domain, '') }}"
        bundle: "{{ ca_certificates | join('\n') }}"
        secret_name: "{{ gitlab_secrets['certs'] }}"
        secret_data: |
          {% set files = {'ca.crt': ca_certificates[1]} %}
          {% for domain in domains %}
          {%   set _ = files.update({domain ~'.crt': bundle}) %}
          {% endfor %}
          {{ files  }}
      ansible.builtin.include_tasks: tasks/k8s/secrets/generic.yml

    - name: Create GitLab storage secret
      vars:
        secret_name: "{{ gitlab_secrets['storage'] }}"
        secret_data:
          # `connection` is used as consolidated object storage config
          # and referenced by global.appConfig.object_store.connection
          # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/to_nice_yaml_filter.html
          connection: "{{ gitlab_minio_config |
            ansible.builtin.to_nice_yaml(indent=2, sort_keys=false) }}"
          # `accesskey` and `secretkey` are used as Runner cache
          # config and referenced by gitlab-runner.runners.cache:
          # https://docs.gitlab.com/runner/install/kubernetes_helm_chart_configuration#amazon-s3
          accesskey: "{{ gitlab_minio_config.aws_access_key_id }}"
          secretkey: "{{ gitlab_minio_config.aws_secret_access_key }}"
      ansible.builtin.include_tasks: tasks/k8s/secrets/generic.yml

    - name: Create GitLab OmniAuth secret
      vars:
        secret_name: "{{ gitlab_secrets['omniauth'] }}"
        secret_data: "{{ gitlab_omniauth_config }}"
      ansible.builtin.include_tasks: tasks/k8s/secrets/generic.yml

    # only to install PostgreSQL extensions
    - name: Create database superuser secret
      ansible.builtin.include_tasks: tasks/postgresql/superuser.yml

    - name: Create GitLab database secret
      vars:
        secret_name: "{{ gitlab_secrets['database'] }}"
        cert_name: gitlab-database
        days: 365
        sans:
          - "{{ gitlab_db_user }}"
          - "{{ gitlab_db_user }}@{{ homelab_domain }}"
      ansible.builtin.include_tasks: tasks/k8s/secrets/tls.step.yml

    - name: Create GitLab passwords secret
      vars:
        secret_name: "{{ gitlab_secrets['passwords'] }}"
        secret_data:
          root: "{{ gitlab_root_pass }}"
          postgresql: "{{ pgpool_pass }}"
          redis: "{{ gitlab_secrets_data['redis'] }}"
          smtp: "{{ icloud_smtp.passwords['gitlab'] }}"
      ansible.builtin.include_tasks: tasks/k8s/secrets/generic.yml

    # create secrets generated by the
    # script: files/gitlab/secrets.sh
    - name: Create generated GitLab secrets
      vars:
        # gitlab_secrets_data is defined in vault-encrypted vars/gitlab.secrets.yml:
        # keys with "gitlab-" prefix will be secret names and their values are data
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/dict2items_filter.html
        secrets: |
          {{ gitlab_secrets_data |
             ansible.builtin.dict2items(key_name='name', value_name='data') |
             selectattr('name', 'search', '^gitlab-') }}
        secret_name: "{{ item.name }}"
        secret_data: "{{ item.data }}"
      ansible.builtin.include_tasks: tasks/k8s/secrets/generic.yml
      loop: "{{ secrets }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Create monitoring scraper secret
      ansible.builtin.include_tasks: tasks/monitoring/scraper.yml

    - name: Install GitLab stack Helm chart
      vars:
        praefect: "{{ gitlab_chart_values.global.praefect }}"
        gitaly: gitaly-{{ praefect.virtualStorages[0].name }}
        zoekt: "{{ gitlab_chart_values['gitlab-zoekt'] }}"

        # default 3s timeout for readiness and liveness
        # probes are too optimistic for our environment
        probe: &probe
          periodSeconds: 10
          timeoutSeconds: 5
        probes: &probes
          readinessProbe: *probe
          livenessProbe: *probe

        # === Inputs ===
        repo_name: gitlab
        repo_url: https://charts.gitlab.io
        chart_ref: gitlab
        chart_ver: "{{ gitlab_chart_version }}"
        release: "{{ gitlab_release_name }}"
        release_ns: "{{ gitlab_namespace }}"
        values: "{{ gitlab_chart_values }}"

        patches:
          merge_patches:
            - apiVersion: apps/v1
              kind: StatefulSet
              metadata:
                name: "{{ gitlab_release_name }}-{{ gitaly }}"
                namespace: "{{ gitlab_namespace }}" # required
              spec:
                template:
                  spec:
                    containers:
                      - name: gitaly
                        <<: *probes
            # the workhorse container probes had been
            # "exec /scripts/healthcheck", which sent
            # a non-HTTPS "GET / HTTP/1.1" request to
            # /dev/tcp/127.0.0.1/8181
            - apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: "{{ gitlab_release_name }}-webservice-default"
                namespace: "{{ gitlab_namespace }}" # required
              spec:
                template:
                  spec:
                    containers:
                      - name: gitlab-workhorse
                        readinessProbe:
                          exec: null # remove
                          httpGet: &http-get
                            path: /-/readiness
                            port: 8181
                            scheme: HTTPS
                        livenessProbe:
                          exec: null
                          httpGet:
                            <<: *http-get
                            path: /-/liveness
            # the Zoekt chart templates only set each
            # probe's httpGet property, leaving other
            # properties as defaults without a way to
            # override them in the values file
            - |
              {% if zoekt.install %}
              apiVersion: apps/v1
              kind: StatefulSet
              metadata:
                name: {{ gitlab_release_name }}-gitlab-zoekt
                namespace: {{ gitlab_namespace }}
              spec:
                template:
                  spec:
                    containers:
                      {{ [ {'name': 'zoekt-indexer'},
                           {'name': 'zoekt-webserver'},
                           {'name': 'zoekt-internal-gateway'},
                         ] | map('ansible.builtin.combine', probes)
                           | to_nice_yaml(indent=2, sort_keys=false)
                           | indent(8) }}
              ---
              apiVersion: apps/v1
              kind: Deployment
              metadata:
                name: {{ gitlab_release_name }}-gitlab-zoekt-gateway
                namespace: {{ gitlab_namespace }}
              spec:
                template:
                  spec:
                    containers:
                      {{ [ {'name': 'zoekt-external-gateway'},
                         ] | map('ansible.builtin.combine', probes)
                           | to_nice_yaml(indent=2, sort_keys=false)
                           | indent(8) }}
              {% endif %}

        extras: # adopt extra resources into Helm release
          - cert-manager.io/v1 Certificate {{ gitlab_secrets['node-tls']      }}
          - cert-manager.io/v1 Certificate {{ gitlab_secrets['database']      }}
          - cert-manager.io/v1 Certificate {{ postgresql_secrets['superuser'] }}
          - cert-manager.io/v1 Certificate {{ monitoring_secrets['scraper']   }}
          - v1 Secret {{ gitlab_secrets['certs']     }}
          - v1 Secret {{ gitlab_secrets['storage']   }}
          - v1 Secret {{ gitlab_secrets['omniauth']  }}
          - v1 Secret {{ gitlab_secrets['passwords'] }}
          - v1 Secret {{ gitlab_secrets['tokens']    }} ? # optional (created later)
          - v1 Secret {{ gitlab_secrets['runner']    }} ? # optional (created later)
          - |
            {% for name, data in gitlab_secrets_data.items() %}
            {%   if name is search('^gitlab-') %}
            v1 Secret {{ name }}
            {%   endif %}
            {% endfor  %}
          - |
            {% if gitlab_enable_istio and
                  gitlab_use_waypoint %}
            gateway.networking.k8s.io/v1 Gateway {{ gitlab_namespace }}-waypoint ?
            {% endif %}

        # this deplopyment is too large to expect
        # everything to be perfect in one run, so
        # allow for manual retries
        atomic: false
        # bootstrapping empty databases could take
        # a long time, with webservice and sidekiq
        # pods having to restart a few times
        wait_timeout: 900
        task_timeout: 1200
      ansible.builtin.include_tasks: tasks/helm/helmfile.yml

    - name: >-
        {{ 'Enable' if enabled else 'Disable' }}
        Istio service mesh
      vars:
        praefect: "{{ gitlab_chart_values.global.praefect }}"
        gitaly: gitaly-{{ praefect.virtualStorages[0].name }}
        services:
          # names without gitlab- prefix
          - webservice-default
          - praefect
          - "{{ gitaly }}"
          - gitlab-shell
          - gitlab-pages
          - gitlab-pages-metrics
          - gitlab-runner
          - gitlab-exporter
          # don't use Waypoint proxy for Redis because
          # it's only for L7 (HTTP/HTTP2/gRPC) traffic
          - redis-metrics

        # === Inputs ===
        enabled: "{{ gitlab_enable_istio }}"
        apps_ns: "{{ gitlab_namespace }}"
        resources: |
          {% set res = [] %}
          {% for svc in services %}
          {%   set _ = res.append({
                 'kind':   'Service',
                 'name':    gitlab_release_name ~'-'~ svc,
                 'enabled': gitlab_use_waypoint,
               })   %}
          {% endfor %}
          {{ res    }}
      ansible.builtin.include_tasks: tasks/istio/mesh.yml
      # sets service_mesh_crds_installed fact

    # add ServiceEntry and DestinationRule
    - name: Configure service mesh rules
      vars:
        state: "{{ 'present' if gitlab_enable_istio else 'absent' }}"
        definition: "{{ lookup('ansible.builtin.template',
          template_dir ~ '/gitlab/mesh.yaml.j2') }}"
      # https://docs.ansible.com/ansible/latest/collections/kubernetes/core/k8s_module.html
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        definition: "{{ definition }}"
        namespace: "{{ gitlab_namespace }}"
        state: "{{ state }}"
        apply: true
      when: service_mesh_crds_installed
      register: mesh_rules

    - name: Stop if mesh JUST configured
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fail_module.html
      ansible.builtin.fail:
        msg: "\n\n\
          Service mesh rules have just been updated. Please wait until\n\
          routing config has fully propagated by ensuring that various\n\
          sections of the UI work as expected, then rerun the playbook\n"
      when:
        - mesh_rules is defined
        - mesh_rules is changed

- name: Configure GitLab installation
  tags: configure
  hosts: localhost
  vars_files:
    - vars/basics.yml
    - vars/harbor.yml
    - vars/gitlab.yml
    - vars/gitlab.configure.yml
    - vars/kubernetes.yml
  vars:
    config_method: shell # uri|shell
    site_base: "{{ gitlab_http_url }}"
    # using YAML anchors allows re-evaluation of
    # facts in tasks to use their current values
    auth_headers_: &auth-headers
      Cookie: "{{ cookie_jar }}"
      X-CSRF-Token: "{{ csrf_token }}"
    html_headers_: &html-headers
      Origin: "{{ site_base }}"
      Referer: "{{ page_url }}"
      Accept: text/html
      <<: *auth-headers
    json_headers_: &json-headers
      Accept: application/json
      <<: *auth-headers
  pre_tasks:
    - name: Gather facts about controller
      ansible.builtin.include_tasks: tasks/localfacts.yml

    - name: Wait until Praefect is ready
      block:
        - name: Wait until Praefect is ready
          vars:
            kubeconfig: "{{ rke_kubeconfig }}"
          ansible.builtin.include_tasks: tasks/gitlab/praefectready.yml
      delegate_to: "{{ rke_control_plane_host }}"

    - name: Wait until GitLab is ready
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/uri_module.html
      ansible.builtin.uri:
        url: "{{ site_base }}/"
        follow_redirects: none
        status_code: [301, 302]
      # https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html#retrying-a-task-until-a-condition-is-met
      retries: 20
      delay: 3
  tasks:
    - name: Authenticate as root user
      # skip because uri module issue:
      # https://github.com/ansible/ansible/issues/85780
      when: config_method == 'uri'
      vars:
        page_url: "{{ site_base }}/users/sign_in"
      block:
        - name: Get CSRF token from page
          vars:
            referer: "{{ site_base }}/"
          ansible.builtin.include_tasks: tasks/gitlab/tokens/csrf.yml
          # sets facts: csrf_token, page_html, cookie_jar

        - name: Authenticate as root user
          ansible.builtin.uri:
            method: POST
            url: "{{ page_url }}"
            # makes no sense why must follow redirects
            # so .cookies is available when Set-Cookie
            # are already returned in the 302 response
            follow_redirects: all
            headers: *html-headers
            body_format: form-urlencoded
            body:
              user[login]: root
              user[password]: "{{ gitlab_root_pass }}"
            # status_code: 302
          register: root_login

        - name: Save issued cookies
          vars:
            cookies_in: "{{ cookie_jar }}"
            uri_result: "{{ root_login }}"
          ansible.builtin.include_tasks: tasks/cookiejar.yml
          # updates cookie_jar fact

    - name: Set application settings
      when: config_method == 'uri'
      vars:
        section: "{{ item.section }}"
        settings: "{{ item.settings }}"
      ansible.builtin.include_tasks: tasks/gitlab/settings.yml
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/dict2items_filter.html
      loop: "{{ gitlab_app_settings |
        ansible.builtin.dict2items(key_name='section', value_name='settings') }}"
      loop_control:
        label: "{{ item.section }}"

    # script will always perform apply,
    # not checking if settings changed
    - name: Configure by shell script
      when: config_method == 'shell'
      vars:
        erhhung_ssh_pub_key: |-
          {{ lookup('ansible.builtin.file', 'files/erhhung/erhhung.pub', rstrip=false) }}
        erhhung_gpg_pub_key: |-
          {{ lookup('ansible.builtin.file', 'files/erhhung/erhhung.asc', rstrip=false) }}
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
      ansible.builtin.shell: |-
        {{ lookup('ansible.builtin.template', template_dir ~ '/gitlab/configure.sh.j2') }}
      args:
        executable: "{{ local_bash_interpreter }}"
      register: configure_sh
      changed_when: configure_sh.stdout is search(':.*(302|200)')
      failed_when: configure_sh.stdout is search(':.*(422|500)') or configure_sh.rc != 0
      # outputs ADMIN_PAT and RUNNER_TOKEN

    - name: Create GitLab PATs secret
      delegate_to: "{{ rke_control_plane_host }}"
      when: config_method == 'shell'
      vars:
        <<: *vars
        admin_pat: >-
          {% set lines = configure_sh.stdout_lines | select('search','^ADMIN_PAT=') -%}
          {{ lines[0].split('ADMIN_PAT=')[1] if lines is truthy else none }}
      block:
        - name: Create GitLab PATs secret
          vars:
            secret_name: "{{ gitlab_secrets['tokens'] }}"
            secret_data:
              admin: "{{ admin_pat }}"
          ansible.builtin.include_tasks: tasks/k8s/secrets/generic.yml
          when: admin_pat is truthy

    - name: Set the runner_token fact
      when: config_method == 'shell'
      ansible.builtin.set_fact:
        runner_token: >-
          {% set lines = configure_sh.stdout_lines | select('search','^RUNNER_TOKEN=') -%}
          {{ lines[0].split('RUNNER_TOKEN=')[1] if lines is truthy else none }}

# requires non-empty runner_token
# fact to be set in previous play
- name: Configure and launch runner
  tags: configure
  hosts: "{{ rke_control_plane_host }}"
  vars_files:
    - vars/kubernetes.yml
    - vars/gitlab.yml
  vars:
    <<: *vars
    facts: "{{ hostvars['localhost'] }}"
    token: "{{ facts['runner_token'] | default(none) }}"
  tasks:
    - name: Create GitLab runner secret
      vars:
        secret_name: "{{ gitlab_secrets['runner'] }}"
        secret_data:
          runner-registration-token: ""
          runner-token: "{{ token }}"
        if_changed: Scale runner to one replica
      ansible.builtin.include_tasks: tasks/k8s/secrets/generic.yml
      when: token is truthy

    - name: Create CI scripts ConfigMap
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: "{{ gitlab_configmaps['scripts'] }}"
            namespace: "{{ gitlab_namespace }}"
          data:
            ci-utils.sh: "{{ lookup('ansible.builtin.file',
              'files/gitlab/ciutils.sh', rstrip=false) }}"
        validate:
          fail_on_error: false
        state: present

    # GitLab Runner pod doesn't appear to auto-reload
    # its config (e.g. config.template.toml) from the
    # ConfigMap unless restarted, so use Wave watcher
    - name: Add Wave annotations to Deployment
      vars:
        res_kind: Deployment
        res_name: "{{ gitlab_release_name }}-gitlab-runner"
        res_ns: "{{ gitlab_namespace }}"
      ansible.builtin.include_tasks: tasks/k8s/wave.yml
  handlers:
    - name: Scale runner to one replica
      kubernetes.core.k8s:
        kubeconfig: "{{ kubeconfig }}"
        api_version: apps/v1
        kind: Deployment
        name: "{{ gitlab_release_name }}-gitlab-runner"
        namespace: "{{ gitlab_namespace }}"
        definition:
          spec:
            replicas: 1
        state: patched
        wait: true

# https://grafana.com/grafana/dashboards/18928-gitlab-jihu-ci-pipelines
# https://github.com/mvisonneau/gitlab-ci-pipelines-exporter
- name: Install Pipelines Exporter
  tags: exporter
  hosts: "{{ rke_control_plane_host }}"
  vars_files:
    - vars/kubernetes.yml
    - vars/monitoring.yml
    - vars/gitlab.secrets.yml
    - vars/gitlab.yml
  vars: *vars
  pre_tasks:
    - name: Get exporter PAT if exists
      kubernetes.core.k8s_info:
        kubeconfig: "{{ kubeconfig }}"
        api_version: v1
        kind: Secret
        name: "{{ pipelines_exporter_secrets['auth'] }}"
        namespace: "{{ secret_ns }}"
      register: exporter_pat
  tasks:
    # https://github.com/mvisonneau/gitlab-ci-pipelines-exporter/tree/main/docs/configuration_syntax.md
    - name: Verify/rotate or create PAT
      vars:
        token: >-
          {{ exporter_pat.resources[0].data['gitlabToken'] | b64decode
          if exporter_pat.resources is truthy else none }}
        pat_name: pipelines-exporter
        scopes:
          - api
          - read_repository
          - self_rotate
      ansible.builtin.include_tasks: tasks/gitlab/tokens/pat.yml
      # sets fact: gitlab_token

    - name: Create exporter auth secret
      vars:
        secret_name: "{{ pipelines_exporter_secrets['auth'] }}"
        secret_data:
          gitlabToken: "{{ gitlab_token }}"
          webhookToken: "{{ gitlab_secrets_data['webhook'] }}"
      ansible.builtin.include_tasks: tasks/k8s/secrets/generic.yml

    - name: Install exporter Helm chart
      vars:
        repo_name: mvisonneau
        repo_url: https://charts.visonneau.fr
        chart_ref: gitlab-ci-pipelines-exporter
        chart_ver: "{{ pipelines_exporter_chart_version }}"
        release: "{{ pipelines_exporter_release_name }}"
        release_ns: "{{ pipelines_exporter_namespace }}"
        values: "{{ pipelines_exporter_chart_values }}"

        extras: # adopt extra resources into Helm release
          - v1 Secret {{ pipelines_exporter_secrets['auth'] }}
      ansible.builtin.include_tasks: tasks/helm/helmfile.yml

    - name: >-
        {{ 'Enable' if enabled else 'Disable' }}
        Istio service mesh
      vars:
        enabled: "{{ gitlab_enable_istio }}"
        apps_ns: "{{ pipelines_exporter_namespace }}"
        resources:
          - kind: Service
            name: "{{ pipelines_exporter_release_name }}"
            enabled: "{{ gitlab_use_waypoint }}"
      ansible.builtin.include_tasks: tasks/istio/mesh.yml

- name: Configure GitLab dashboards
  tags: dashboards
  hosts: localhost
  vars_files:
    - vars/gitlab.yml
  tasks:
    - name: Import Grafana dashboards
      vars:
        dashboards: "{{ gitlab_grafana_dashboards }}"
      ansible.builtin.include_tasks: tasks/grafana/dashboards.yml
