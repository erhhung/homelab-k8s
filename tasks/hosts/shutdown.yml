# pass the following vars:
#   services [optional] list of services
#   commands [optional] list of commands
---
- name: Shut down host "{{ inventory_hostname }}"
  become: true
  block:
    - name: Stop services
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/systemd_service_module.html
      ansible.builtin.systemd_service:
        name: "{{ item }}"
        state: stopped
      loop: "{{ services }}"
      when:
        - services is defined
        - services is iterable
        - services is truthy
      failed_when: false

    - name: Run commands
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html
      ansible.builtin.command: "{{ item }}"
      loop: "{{ commands }}"
      when:
        - commands is defined
        - commands is iterable
        - commands is truthy
      changed_when: true

    - name: Halt system
      # https://docs.ansible.com/ansible/latest/collections/community/general/shutdown_module.html
      community.general.shutdown:
      # https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_async.html
      async: 20
      poll: 0
  any_errors_fatal: true
