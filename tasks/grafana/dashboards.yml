# import one or more Grafana dashboards by JSON or by
# gnetId from https://grafana.com/grafana/dashboards/
#
# pass the following vars:
#   dashboards: <required> dashboard list
#     - title   <required> official title
#       json    [optional] dashboard JSON (mutually
#                exclusive with gnet_id and filter)
#       gnet_id [required] grafana.com dashboard ID
#       filter  [optional] filter by description
#       ds_var  [optional] default=DS_PROMETHEUS
#       inputs: [optional] extra variables
#         - name
#           type
#           value
#       tags       [optional] additional tags
#       jq_patches [optional] jq queries list
#   (following vars are default values for all
#   dashboards unless overridden individually)
#   filter      [optional] default .filter
#   ds_var      [optional] default .ds_var
#   inputs      [optional] default .inputs
#   tags        [optional] default .tags
#
# IMPORTANT: if jq_patches are provided, it's
# imperative that each query (executed as-is)
# returns the document root
---
- name: Gather facts about controller
  # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_tasks_module.html
  ansible.builtin.include_tasks: tasks/localfacts.yml
  when: local_python_interpreter is undefined

- name: Include vars/monitoring.yml
  # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_vars_module.html
  ansible.builtin.include_vars: vars/monitoring.yml
  when: grafana_url is undefined

- name: Import Grafana dashboards
  delegate_to: localhost
  become: false
  vars:
    ansible_python_interpreter: "{{ local_python_interpreter }}"
    api_base: "{{ grafana_url }}/api"
    admin_user: "{{ grafana_admin_user }}"
    admin_pass: "{{ grafana_admin_pass }}"
  block:
    - name: Find existing dashboards
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/uri_module.html
      ansible.builtin.uri:
        url: "{{ api_base }}/search?type=dash-db&limit=5000"
        url_username: "{{ admin_user }}"
        url_password: "{{ admin_pass }}"
        force_basic_auth: true
        return_content: true
      # https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html#retrying-a-task-until-a-condition-is-met
      register: existing_dashboards
      retries: 5
      delay: 2

    - name: Import Grafana dashboard
      vars:
        existing: "{{ existing_dashboards.json | map(attribute='title') }}"
        api_auth: "{{ admin_user }}:'{{ admin_pass }}'"
      block:
        - name: Import dashboard by JSON
          vars: &vars
            patches: "{{ item.jq_patches | default([]) }}"
            script1: |-
              json="$(jq 'del(.id) | .title = "{{ item.title }}"' <<< "$json")"

              tags='{{ item.tags | default(tags | default([])) |
                                   to_json(separators=[',',':']) }}'
              [ "$tags" == "[]" ] || json="$(jq ".tags += $tags" <<< "$json")"
              json="$(jq   '.tags |= map(ascii_downcase)'        <<< "$json")"

              {% if patches is truthy  %}
              {%   for expr in patches %}
              patch_{{ loop.index }}="$(cat <<'EOT'
              {{ expr }}
              EOT
              )"
              {%   endfor %}
              for i in $(seq {{ patches | length }}); do
                echo "Applying patch $i/{{ patches | length }}..."
                patch_var="patch_$i"
                json="$(jq "${!patch_var}" <<< "$json")"
              done

              {% endif %}
              ds_var='{{ item.ds_var | default(ds_var | default('DS_PROMETHEUS')) }}'
              inputs='{{ item.inputs | default(inputs | default([])) |
                                       to_json(separators=[',',':']) }}'
              inputs="$(jq  --argjson inputs "$inputs" '. + $inputs' <<JSON
              [{
                "name":     "$ds_var",
                "type":     "datasource",
                "pluginId": "prometheus",
                "value":    "Prometheus"
              }]
              JSON
              )"
            script2: |-
              jq -cM <<JSON | \
                curl -X POST  -fku {{ api_auth }} -m 60  \
                     -H 'Content-Type: application/json' \
                  --no-progress-meter "${retry_opts[@]}" \
                  {{ api_base }}/dashboards/import -d @- | jq
              {
                "folderUid": "",
                "overwrite": true,
                "dashboard": $json,
                "inputs":    $inputs
              }
              JSON
          # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
          ansible.builtin.shell: |
            set -eo pipefail

            json="$(cat <<'JSON'
            {{ item.json }}
            JSON
            )"
            {{ script1 }}

            echo "Importing {{ item.title }}..."
            {{ script2 }}
          args:
            executable: /bin/bash
          loop: "{{ dashboards | selectattr('json', 'defined') }}"
          loop_control:
            label: "{{ item.title }}"
          when: item.title not in existing
          register: import_by_json
          changed_when: import_by_json.rc == 0
          failed_when: >-
            import_by_json.rc not in [0,9] or
            import_by_json.stdout is search('failed')
          retries: 3
          delay: 5

        # https://istio.io/latest/docs/ops/integrations/grafana#option-2-import-from-grafanacom-into-an-existing-deployment
        - name: Import dashboard by gnetId
          vars: *vars
          ansible.builtin.shell: |
            set -eo pipefail

            revs_url="https://grafana.com/api/dashboards/{{ item.gnet_id }}/revisions"
            retry_opts=(--retry 5 --retry-delay 2)

            # find latest revision that matches filter
            filter='{{ item.filter | default(filter | default('')) }}'
            [ "$filter" ] && \
                filter="| select(.description | contains(\"$filter\"))"

            rev=$(curl -sfL "$revs_url" | \
              jq -r  "[.items[] $filter | .revision] | max")
            desc="revision $rev of {{ item.title }} ({{ item.gnet_id }})"

            echo "Downloading $desc..."
            echo "URL: $revs_url/$rev/download"
            json="$(curl -fsSL "${retry_opts[@]}" "$revs_url/$rev/download")"
            {{ script1 }}

            TMP_DIR=/tmp/grafana
            mkdir -p "$TMP_DIR"

            file="$TMP_DIR/{{ item.gnet_id }}-$rev"
            echo "$revs_url/$rev/download" > "$file-dashboard.url"
            echo "$json"                   > "$file-dashboard.json"
            echo "$inputs"                 > "$file-inputs.json"

            echo "Importing $desc..."
            {{ script2 }}

            rm -f $file-*
          args:
            executable: /bin/bash
          loop: "{{ dashboards | selectattr('json', 'undefined') }}"
          loop_control:
            label: "{{ item.title }}"
          when: item.title not in existing
          register: import_by_gnetid
          changed_when: import_by_gnetid.rc == 0
          failed_when: >-
            import_by_gnetid.rc not in [0,9] or
            import_by_gnetid.stdout is search('failed')
          retries: 3
          delay: 5
