---
- name: Show local and remote facts
  tags: facts
  hosts:
    - "{{ k3s_control_plane_host }}"
    - "{{ rke_control_plane_host }}"
  gather_facts: true
  vars_files:
    - vars/kubernetes.yml
  vars:
    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/ternary_filter.html
    cluster: "{{ (inventory_hostname in groups['k3s_cluster']) | ternary('K3s','RKE') }}"
    cp_host: "{{ vars[cluster | lower ~'_control_plane_host'] }}"
  pre_tasks:
    - name: Gather facts about controller
      run_once: true
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_tasks_module.html
      ansible.builtin.include_tasks: tasks/localfacts.yml

    - name: Gather facts about {{ cluster }} cluster
      when: inventory_hostname == cp_host
      vars:
        kubeconfig: "{{ vars[cluster | lower ~'_kubeconfig'] }}"
      ansible.builtin.include_tasks: tasks/k8s/clusterfacts.yml
  tasks:
    - name: Show controller facts
      run_once: true
      vars:
        facts:
          local_python_interpreter: "{{ local_python_interpreter }}"
          local_bash_interpreter: "{{ local_bash_interpreter }}"
          local_machine_arch: "{{ local_machine_arch }}"
          local_tz_offset: "{{ local_tz_offset }}"
      ansible.builtin.debug:
        var: facts

    - name: Show {{ cluster }} cluster facts
      when: inventory_hostname == cp_host
      vars:
        facts:
          kubernetes_version: "{{ kubernetes_version }}"
          # list of CRDs can be very long!
          kubernetes_apis: "{{ kubernetes_apis }}"
      ansible.builtin.debug:
        var: facts

    - name: Dump "ansible_date_time"
      ansible.builtin.debug:
        var: ansible_date_time

    - name: Dump "ansible_version"
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/debug_module.html
      ansible.builtin.debug:
        var: ansible_version

    # output is usually empty!
    - name: Dump "ansible_local"
      ansible.builtin.debug:
        var: ansible_local

    # output can be very long!
    - name: Dump "ansible_facts"
      ansible.builtin.debug:
        var: ansible_facts

    - name: Format current time
      run_once: true
      vars:
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/strftime_filter.html
        time_now: "{{ '%Y-%m-%dT%H:%M:%S' | strftime() }}{{ local_tz_offset.in_hh_mm }}"
      ansible.builtin.debug:
        var: time_now

- name: Show hosts and domain names
  tags: hosts
  hosts: localhost
  tasks:
    - name: Show inventory groups
      ansible.builtin.debug:
        msg: |-
          groups['all']:                  {{ groups['all']     }}
          groups['k8s_all']:              {{ groups['k8s_all'] }}
          groups['rke_cluster']:          {{ groups['rke_cluster'] }}
          groups['rke_control_plane']:    {{ groups['rke_control_plane']    }}
          groups['rke_control_plane_ha']: {{ groups['rke_control_plane_ha'] }}
          groups['rke_workers']:          {{ groups['rke_workers']    }}
          groups['rke_workers_ha']:       {{ groups['rke_workers_ha'] }}

    - name: Generate cluster FQDNs
      vars:
        rke_cluster_name: homelab
        rke_fqdns: >
          {{ ([rke_cluster_name] + groups['rke_control_plane']) |
               product(search_domains) | map('join','.') }}
      ansible.builtin.debug:
        msg: |-
          rke_fqdns[0]:  {{ rke_fqdns[0]  }}
          rke_fqdns[1:]: {{ rke_fqdns[1:] }}

    - name: Generate subdomain FQDNs
      vars:
        subdomain: thanos
        thanos_hosts:
          - query
          - rule
          - store
        thanos_pqdns: "{{ thanos_hosts | map('regex_replace', '$', '.'~ subdomain)  }}"
        thanos_fqdns: "{{ thanos_pqdns | product(search_domains) | map('join', '.') }}"
      ansible.builtin.debug:
        var: thanos_fqdns

    - name: Generate hosts entries
      vars:
        search_domains:
          - "{{ homelab_domain }}"
          - erhhungyuan.com
        rke_cluster_name: homelab
        rke_ha_mode: true
        k8s_hosts: |
          {% set hosts = groups['k8s_all'] %}
          {% if rke_ha_mode %}
          {%   set _ = hosts.append(rke_cluster_name) %}
          {% endif %}
          {{ hosts }}
        host_ip: "{{ hostvars[host].ansible_host }}"
        # if HA mode, the host "homelab" (cluster name) has its own virtual IP
        # if not HA mode, homelab is an alias for the first control plane node
        host_names: |
          {% set use_alias = not rke_ha_mode and host == rke_control_plane_host %}
          {{ [host, rke_cluster_name] if use_alias else [host] }}
        host_fqdns: "{{ host_names | product(search_domains) | map('join', '.')  | list }}"
        host_pairs: "{{ host_fqdns | map('regex_replace', '^([^.]+)', '\\1 \\1') | list }}"
        host_entry: "{{ ([host_ip] + (host_pairs | join(' ')) | split | unique) | join(' ') }}"
      ansible.builtin.debug:
        msg: "{{ host_entry }}"
      loop: "{{ k8s_hosts }}"
      loop_control:
        loop_var: host
        label: "{{ host_ip }}|{{ host }}"

- name: Show certificates on CA server
  tags: certs
  hosts: pki_any
  tasks:
    - name: Fetch cert file
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html
      ansible.builtin.command: cat certs/rancher.pem
      register: cat_cert
      changed_when: false

    - name: Print PEM output
      ansible.builtin.debug:
        msg: "{{ cat_cert.stdout }}"

    - name: Print cert secret
      vars:
        # split chain into individual certs:
        # host, intermediate CA, and root CA
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/regex_findall_filter.html
        chain: |
          {{ cat_cert.stdout | ansible.builtin.regex_findall(
            '(-----BEGIN CERTIFICATE-----(?:\n\S+)+\n-----END CERTIFICATE-----)',
             multiline=true) }}
        secret:
          # tls.crt: host and intermediate CA certs
          tls.crt: "{{ chain[:-1] | join('\n') }}"
          ca.crt: "{{  chain[-1:] | join('\n') }}"
      ansible.builtin.debug:
        var: secret

    - name: Show unvaulted key
      ansible.builtin.debug:
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/unvault_lookup.html
        msg: "ca.key: {{ lookup('ansible.builtin.unvault', 'files/harbor/ca.key') }}EOF"

- name: Dump Helm chart values files
  tags: values
  hosts: localhost
  vars_files:
    - vars/kubernetes.yml
    - vars/storage.yml
    - vars/harbor.yml
  tasks:
    - name: Write Helm chart values file
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
      ansible.builtin.shell: |
        set -o pipefail
        jq <<'JSON' | yq -pj -oy > /tmp/{{ item.dest }}
        {{ item.json }}
        JSON
      args:
        executable: /bin/bash
      loop:
        # must serialize to JSON outside of shell script before loop begins
        - json: "{{ harbor_chart_values | to_json(separators=[',',':']) }}"
          dest: values-harbor.yaml
      loop_control:
        label: "{{ item.dest }}"
      changed_when: true

- name: Get list of files on remote host
  tags: files
  hosts: cosmos
  tasks:
    - name: Find ~/accounts/*.txt files
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/find_module.html
      ansible.builtin.find:
        paths: ~/accounts/
        follow: true
        recurse: true
        patterns: "*.txt"
        get_checksum: true
      register: find_files

    # filter out irrelevant file stats
    - name: Show list of matched files
      vars:
        # ansible_user_dir requires gather_facts
        path: "{{ ansible_user_dir }}/accounts/"
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/strftime_filter.html
        files: |
          {% set files = [] %}
          {% set n     = path | length    %}
          {% for file in find_files.files %}
          {%   set _ = files.append({
                 'path':  file.path[n:],
                 'sha1':  file.checksum,
                 'size':  file.size,
                 'mtime': '%Y-%m-%d %H:%M:%S' | strftime(file.mtime),
               })   %}
          {% endfor %}
          {{ files  }}
      ansible.builtin.debug:
        var: files

- name: Debug basic Ansible/Jinja syntax
  tags: syntax
  hosts: localhost
  tasks:
    - name: Create IP address range
      vars:
        metallb_vip: 192.168.4.231
        valkey_node_count: 6
        valkey_lb_ips: |
          {% set ips = [] %}
          {% for i in range(valkey_node_count) %}
          {%   set _ = ips.append(metallb_vip | ansible.utils.ipmath(i)) %}
          {% endfor %}
          {{ ips    }}
      ansible.builtin.debug:
        var: valkey_lb_ips

    - name: Flatten nested lists
      vars:
        add_list:
          - id: 1
            names: ["foo", "bar"]
          - id: 2
            names: ["bar", "baz"]
        the_list: |
          {% set items = [] %}
          {% set _ = items.append(add_list) %}
          {# https://docs.ansible.com/ansible/latest/collections/ansible/builtin/flatten_filter.html #}
          {{ items | ansible.builtin.flatten }}
      ansible.builtin.debug:
        var: the_list

    # NOTE: this doesn't work because omit loses
    # its special value when passed as loop item
    - name: Test 'omit' variable
      vars:
        original:
          foo:
            bar: xyz
          bar:
            baz: 123
        patched: "{{ original | combine(item, recursive=true) }}"
      ansible.builtin.debug:
        var: patched
      loop:
        - hello: world
          bar: "{{ omit }}"
        - test: 123
          foo: "{{ omit }}"

    - name: Test loop variables
      vars:
        items:
          - foo
          - bar
          - baz
      block:
        - name: Echo loop item
          ansible.builtin.command: date +"{{ ansible_loop.index }}-{{ item }}-%s"
          loop: "{{ items }}"
          loop_control:
            # https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html#extended-loop-variables
            extended: true
            # https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html#pausing-within-a-loop
            pause: 2
          register: echo_item
          changed_when: false

        - name: Show echo results
          vars:
            j: "{{ ansible_loop.index0 }}"
          ansible.builtin.debug:
            msg: |
              i (index_var):          {{ i }}
              j=ansible_loop.index0:  {{ j }}
              stdout:                 {{ item.stdout }}
              stdout[{{ i }}]:              {{ echo_item.results[i].stdout }}
              stdout[{{ j }}]:              {{ echo_item.results[j].stdout }}
          loop: "{{ echo_item.results }}"
          loop_control:
            extended: true
            label: "{{ item.item }}"
            index_var: i

        - name: Show loop vars
          ansible.builtin.debug:
            msg: |
              item:                   {{ item }}
              ansible_loop.index:     {{ ansible_loop.index }}
              ansible_loop.index0:    {{ ansible_loop.index0 }}
              ansible_loop.revindex:  {{ ansible_loop.revindex }}
              ansible_loop.revindex0: {{ ansible_loop.revindex0 }}
              ansible_loop.first:     {{ ansible_loop.first }}
              ansible_loop.last:      {{ ansible_loop.last }}
          loop: "{{ items }}"
          loop_control:
            extended: true
            # https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html#breaking-out-of-a-loop
            break_when: item == 'bar'

        - name: Loops in Jinaj2
          vars:
            stats: |
              {% set stats = [] %}
              {% for item in items %}
              {%   set _ = stats.append({
                     'item':           item,
                     'loop.index':     loop.index,
                     'loop.index0':    loop.index0,
                     'loop.revindex':  loop.revindex,
                     'loop.revindex0': loop.revindex0,
                     'loop.first':     loop.first,
                     'loop.last':      loop.last,
                   })   %}
              {% endfor %}
              {{ stats  }}
          ansible.builtin.debug:
            var: stats

- name: Debug expressions and statements
  tags: exprs
  hosts: localhost
  tasks:
    - name: Select items not in list
      vars:
        all_list: ["foo", "bar", "baz", "qux"]
        bad_list: ["bar", "qux"]
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/difference_filter.html
        the_list: "{{ all_list | ansible.builtin.difference(bad_list) }}"
      ansible.builtin.debug:
        var: the_list

    - name: Debug filtering functions
      vars:
        vcluster_pods:
          - ^kube-system/coredns-.*$
        get_pods: # kubernetes.core.k8s_info
          resources:
            - metadata:
                name: coredns-668c87c5d8-mjp84
                namespace: kube-system
            - metadata:
                name: argocd-application-controller-0
                namespace: argocd
        user_pods: |
          {% set pods = [] %}
          {% for meta in get_pods.resources | map(attribute='metadata') %}
          {%   set desc = meta.namespace ~'/'~ meta.name %}
          {#   use namespace() to create a scoped object #}
          {#   https://jinja.palletsprojects.com/en/stable/templates#assignments #}
          {%   set pod = namespace(desc=desc, found=false) %}
          {%   for regex in vcluster_pods %}
          {%     if not pod.found and pod.desc | ansible.builtin.regex_search(regex) %}
          {%        set pod.found = true %}
          {%     endif %}
          {%   endfor  %}
          {%   if not pod.found %}
          {%     set _ = pods.append({
                   'name':      meta.name,
                   'namespace': meta.namespace
                 })  %}
          {%   endif %}
          {% endfor  %}
          {{ pods    }}
      ansible.builtin.debug:
        var: user_pods

    - name: Debug regular expressions
      vars:
        find: install
        text: Host purged; no K3s/Rancher; before installing RKE2
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/search_test.html
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/regex_escape_filter.html
        found: "{{ text is search(find | regex_escape, ignorecase=true) }}"
      ansible.builtin.debug:
        msg: |2-
           find: {{ find }}
           text: {{ text }}
          found: {{ found }}

    - name: Debug certificate SANs
      vars:
        fqdns:
          - foo1.{{ homelab_domain }}
          - foo2.{{ homelab_domain }}
        sans_:
          - foo
          - "{{ fqdns }}"
          - "*.foo.svc.cluster.local"
          - "*.foo.svc"
          - admin@{{ homelab_domain }}
          - "{{ cluster_node_ips }}"
        sans: "{{ sans_ | flatten }}"
        cn: "{{ sans | first }}"
        ips: "{{ sans | select('search', '^[0-9]+\\.') }}"
        emails: "{{ sans | select('search', '@') }}"
        # too bad ansible.builtin.difference filter
        # does not maintain the original list order
        dns: |
          {% set dns = [] %}
          {% for san in sans %}
          {%   if san not in ips and san not in emails
                                 and san is search('\\.') %}
          {%     set _ = dns.append(san) %}
          {%   endif %}
          {% endfor %}
          {% if dns | length > 0 and cn != dns[0] %}
          {%   set _ = dns.insert(0, cn) %}
          {% endif %}
          {{ dns   }}
        usages: |
          {% set usages = ['digital signature'] %}
          {% if dns is truthy or ips is truthy  %}
          {%   set _ = usages.append('key encipherment') %}
          {%   set _ = usages.append('server auth')      %}
          {% endif %}
          {% if emails is truthy %}
          {%   set _ = usages.append('client auth') %}
          {% endif  %}
          {{ usages }}
      ansible.builtin.debug:
        msg: |2-
              commonName: {{ cn  }}
                dnsNames: {{ dns }}
             ipAddresses: {{ ips }}
          emailAddresses: {{ emails }}
                  usages: {{ usages }}

    - name: Debug create query string
      vars:
        query_params:
          ssl: "true"
          sslmode: verify-full
          sslcert: /tmp/tls/tls.crt
          sslkey: /tmp/tls/tls.key
          sslrootcert: /tmp/tls/ca.crt
        query_string: |-
          {% set  items = query_params | dict2items -%}
          {% set params = items | map(attribute='key')    |
                      zip(items | map(attribute='value')) |
                      map('join','=') -%}
          {{ params | join('&') }}
      ansible.builtin.debug:
        var: query_string

    # https://docs.ansible.com/ansible/latest/collections/community/general/docsite/filter_guide_working_with_times.html
    - name: Debug datetime/timedelta
      block:
        # NOTE: ansible_date_time is defined only if gather_facts is
        # true or the ansible.builtin.setup module is run explicitly
        - name: Gather facts about date/time
          # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html
          ansible.builtin.setup:
            gather_subset: date_time
          when: ansible_date_time is not defined

        - name: Get days until expiration
          vars:
            # IMPORTANT! date must be quoted or else Ansible converts
            # it to _AnsibleTaggedDate object, which cannot be passed
            # to ansible.builtin.to_datetime
            expires: "2025-11-04"
            # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/to_datetime_filter.html
            # https://docs.python.org/3/library/datetime.html#datetime.datetime
            # https://docs.python.org/3/library/datetime.html#timedelta-objects
            dt_exp: "{{ expires                | ansible.builtin.to_datetime('%Y-%m-%d') }}"
            dt_now: "{{ ansible_date_time.date | ansible.builtin.to_datetime('%Y-%m-%d') }}"
            days_left: "{{ (dt_exp - dt_now).days }}" # noqa jinja[invalid]
          ansible.builtin.debug:
            var: days_left

- name: Debug various Ansible filters
  tags: filters
  hosts: localhost
  tasks:
    - name: Test from_yaml_all filter
      vars:
        enabled: true
        yaml: |
          {% if enabled %}
          doc:
            foo: abc
          ---
          doc:
            bar: xyz
          {% endif %}
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/from_yaml_all_filter.html
        objs: "{{ yaml | from_yaml_all }}"
      ansible.builtin.debug:
        var: objs # [] if disabled

    - name: Debug password_hash filter
      vars:
        credentials:
          user11: password1
          user12: password1
          user21: password2
          user22: password2
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/password_hash_filter.html
        # (requires Python packages "passlib" and "bcrypt==4.0.1" on Ansible controller)
        # bcrypt_salt is group var (must be exactly 22 characters) defined in common.yml
        username_hash: "{{ item[0] | ansible.builtin.password_hash('bcrypt', salt=bcrypt_salt, rounds=bcrypt_rounds) }}"
        custom_salt: "{{ username_hash[-1 * bcrypt_salt | length :]}}"
        password_hash: "{{ item[1] | ansible.builtin.password_hash('bcrypt', salt=custom_salt, rounds=bcrypt_rounds) }}"
      ansible.builtin.debug:
        var: password_hash
      loop: "{{ credentials.items() }}"
      loop_control:
        label: "{{ item[0] }}"

    - name: Filter list by item type
      vars:
        original:
          - foo
          - 123
          - bar
          - foo: bar
          - 45.67
          - true
          - baz
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/string_test.html
        strings: "{{  original | select('string')  }}"
        integers: "{{ original | select('integer') }}"
        floats: "{{   original | select('float')   }}"
        booleans: "{{ original | select('boolean') }}"
        mappings: "{{ original | select('mapping') }}"
      ansible.builtin.debug:
        msg: |-
          original: {{ original }}
           strings: {{ strings  }}
          integers: {{ integers }}
            floats: {{ floats   }}
          booleans: {{ booleans }}
          mappings: {{ mappings }}

    - name: Debug dict2items filter
      vars:
        users:
          alice:
            age: 18
            email: alice@example.com
          bob:
            age: 21
            email: bob@example.com
      ansible.builtin.debug:
        var: item.info
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/dict2items_filter.html
      loop: "{{ users | ansible.builtin.dict2items(key_name='user', value_name='info') }}"
      loop_control:
        label: "{{ item.user }}"

    - name: Debug dict_kv filter
      vars:
        dashboards:
          - title: Istio / Mesh
            gnet_id: 7639
          - title: Istio / Ztunnel
            gnet_id: 21306
          - title: Istio / Service
            gnet_id: 7636
          - title: Istio / Workload
            gnet_id: 7630
          - title: Istio / Performance
            gnet_id: 11829
          - title: Istio / Control Plane
            gnet_id: 7645
          - title: Istio / Wasm Extension
            gnet_id: 13277
        # https://docs.ansible.com/ansible/latest/collections/community/general/dict_kv_filter.html
        names: "{{ dashboards | map(attribute='title') | map('community.general.dict_kv', 'name') }}"
      ansible.builtin.debug:
        var: names

    - name: Debug remove_keys filter
      vars:
        dirty:
          apiVersion: v1
          kind: Pod
          metadata:
            name: mypod
            namespace: default
            labels:
              app: myapp
            uid: 12345
            creationTimestamp: "2024-01-01T00:00:00Z"
            resourceVersion: "67890"
            managedFields:
              - manager: kubelet
                operation: Update
                apiVersion: v1
                time: "2024-01-01T00:00:00Z"
            generation: 1
          spec:
            containers:
              - name: mycontainer
                image: myimage:latest
          status:
            phase: Running
        # https://docs.ansible.com/ansible/latest/collections/community/general/remove_keys_filter.html
        # doesn't work as remove_keys
        # doesn't support nested keys
        clean1: |
          {{ [dirty] | community.general.remove_keys(target=[
             'metadata.uid',
             'metadata.creationTimestamp',
             'metadata.resourceVersion',
             'metadata.managedFields',
             'metadata.generation',
             'status',
             ]) | first }}
        # using combine() with omit works!
        clean2: |
          {{ dirty | ansible.builtin.combine({
            'metadata': {
              'uid':               omit,
              'creationTimestamp': omit,
              'resourceVersion':   omit,
              'managedFields':     omit,
              'generation':        omit,
            },
            'status': omit,
          }, recursive=true) }}
      ansible.builtin.debug:
        var: clean2

    - name: Is truthy expression
      vars:
        expressions:
          - desc: empty string
            expr: ""
          - desc: 1-item list
            expr: ["foo"]
          - desc: empty list
            expr: []
          - desc: 1-key dict
            expr: { foo: bar }
          - desc: empty dict
            expr: {}
          - desc: number one
            expr: 1
          - desc: number zero
            expr: 0
      ansible.builtin.debug:
        msg: "{{ item.desc }}: {{ item.expr is truthy }}"
      loop: "{{ expressions }}"
      loop_control:
        label: "{{ item.desc }}"

- name: Debug various Ansible lookups
  tags: lookups
  hosts: localhost
  tasks:
    - name: Debug url lookup
      vars:
        url: https://raw.githubusercontent.com/intel/intel-device-plugins-for-kubernetes/refs/heads/main/deployments/nfd/overlays/node-feature-rules/node-feature-rules.yaml
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/url_lookup.html
        content: "{{ lookup('ansible.builtin.url', url, split_lines=false) | from_yaml }}"
      ansible.builtin.debug:
        var: content

    # lookup_plugins/one_bucket_iam_policy.py
    - name: Custom one_bucket_iam_policy lookup
      vars:
        rw_policy: "{{ lookup('one_bucket_iam_policy', 'backups') }}"
        ro_policy: "{{ lookup('one_bucket_iam_policy', 'configs', readonly=true) }}"
        policies: "{{ {
          'rw_policy': rw_policy,
          'ro_policy': ro_policy,
          } }}"
      ansible.builtin.debug:
        var: policies

    - name: Debug fileglob lookup
      vars:
        base_dir: "{{ template_dir }}/argocd/projects"
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fileglob_lookup.html
        # https://docs.ansible.com/ansible/latest/plugins/lookup.html#forcing-lookups-to-return-lists-query-and-wantlist-true
        manifests:
          "{{ query('ansible.builtin.fileglob', base_dir ~ '/*.yaml*') |
          map('ansible.builtin.basename') | select('search', '^[^.].+') }}"
      ansible.builtin.debug:
        var: item
      # names not sorted by default
      loop: "{{ manifests | sort }}"
      loop_control:
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/regex_replace_filter.html
        label: "{{ item | ansible.builtin.regex_replace('\\.yaml(\\.j2)?$', '') }}"

- name: Ansible quirks and behaviors
  tags: quirks
  hosts: localhost
  tasks:
    - name: Modify loaded variable
      block:
        - name: Include vars/wave.yml
          # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_vars_module.html
          ansible.builtin.include_vars: vars/wave.yml

        - name: Add extra annotations
          vars:
            extras:
              extra-secrets: another-secret
            annotations: |
              {% set annos = wave_optin_annotation %}
              {% for anno, value in extras.items() %}
              {%   set _ = annos.update({
                     'wave.pusher.com/' ~ anno: value
                   })   %}
              {% endfor %}
              {{ annos  }}
          ansible.builtin.debug:
            var: annotations

        - name: Show original variable
          ansible.builtin.debug:
            var: wave_optin_annotation

    - name: Detect changes in subtasks
      block:
        - name: Reset loop_changes fact
          ansible.builtin.set_fact:
            loop_changes: []

        - name: include_tasks iterations
          vars:
            debug_var: "{{ item }}"
            change_if: bar
          ansible.builtin.include_tasks: tasks/debug.yml
          loop: ["foo", "bar", "baz"]

        - name: Any changes in subtasks?
          ansible.builtin.debug:
            var: loop_changes
          changed_when: loop_changes is any

- name: Useful collection of tasks
  tags: tasks
  hosts: localhost
  tasks:
    - name: Fail and display message
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/fail_module.html
      ansible.builtin.fail:
        msg: "\n\n\
          The task just failed.\n\
          No, it really FAILED!\n"

    - name: Exit the play successfully
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/meta_module.html
      ansible.builtin.meta: end_play
