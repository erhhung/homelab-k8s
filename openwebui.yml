# https://docs.openwebui.com/
# https://docs.openwebui.com/getting-started/quick-start
# https://docs.openwebui.com/features/rag
# https://docs.openwebui.com/features/plugin
# https://openwebui.com/tools
---
- name: Install Open WebUI on RKE cluster
  tags: install
  hosts: "{{ rke_control_plane_host }}"
  vars_files:
    - vars/kubernetes.yml
    - vars/postgresql.yml
    - vars/valkey.yml
    - vars/storage.yml
    - vars/minio.yml
    - vars/ollama.yml
    - vars/qdrant.yml
    - vars/openwebui.yml
  vars:
    # required kubernetes>=24.2 package only in user virtualenv
    ansible_python_interpreter: "{{ venv_python_interpreter }}"
    kubeconfig: "{{ rke_kubeconfig }}"
    secret_ns: "{{ openwebui_namespace }}"
    create_ns: false
  pre_tasks:
    # used as image tag in init containers
    - name: Get Open WebUI chart appVersion
      block:
        # there isn't a kubernetes.core.* module
        # to get info about a chart, only to get
        # info about an installed release
        - name: Run `helm show chart` command
          # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/command_module.html
          ansible.builtin.command:
            argv:
              - helm
              - show
              - chart
              - open-webui
              # don't quote args as this isn't shell!
              - --repo={{ openwebui_chart_repo_url }}
              - --version={{ openwebui_chart_version }}
          register: show_chart
          changed_when: false

        - name: Set openwebui_app_version fact
          vars:
            chart_info: "{{ show_chart.stdout | from_yaml }}"
          # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/set_fact_module.html
          ansible.builtin.set_fact:
            openwebui_app_version: "{{ chart_info.appVersion }}"

    - name: Get the PostgreSQL image used
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_tasks_module.html
      ansible.builtin.include_tasks: tasks/postgresql/image.yml
      when: postgresql_image is undefined
  tasks:
    - name: Create Open WebUI ingress secret
      vars:
        secret_name: "{{ openwebui_secrets['ingress'] }}"
        create_ns: true
        cert_name: open-webui-ingress
        sans: "{{ openwebui_fqdns }}"
      ansible.builtin.include_tasks: tasks/k8s/secrets/tls.step.yml

    - name: Create Open WebUI database secret
      vars:
        secret_name: "{{ openwebui_secrets['database'] }}"
        cert_name: open-webui-database
        days: 365
        sans:
          - "{{ openwebui_db_user }}"
          - "{{ openwebui_db_user }}@{{ homelab_domain }}"
      ansible.builtin.include_tasks: tasks/k8s/secrets/tls.step.yml

    # https://docs.openwebui.com/getting-started/env-configuration
    - name: Create Open WebUI extraEnv secret
      vars:
        pipelines: "{{ openwebui_chart_values.pipelines }}"
        secret_name: "{{ openwebui_secrets['env-vars'] }}"
        secret_data:
          # secret key used to sign JWTs:
          # https://docs.openwebui.com/getting-started/env-configuration#webui_secret_key
          WEBUI_SECRET_KEY: "{{ openwebui_secret_key }}"
          # https://docs.openwebui.com/getting-started/env-configuration#database-pool
          DATABASE_URL: "{{ openwebui_postgresql_url }}"
          # https://docs.openwebui.com/getting-started/env-configuration#redis
          REDIS_URL: "{{ openwebui_redis_url }}"
          # https://docs.openwebui.com/getting-started/env-configuration#qdrant
          QDRANT_API_KEY: "{{ qdrant_api_key.read_write }}"
          # https://docs.openwebui.com/getting-started/env-configuration#s3_secret_access_key
          S3_SECRET_ACCESS_KEY: "{{ minio_client_pass }}"
          # Pipelines key must be first:
          # https://docs.openwebui.com/getting-started/env-configuration#openai_api_keys
          # https://docs.openwebui.com/pipelines#-quick-start-with-docker
          OPENAI_API_KEYS: >-
            {% set keys = [openai_api_key] -%}
            {% if pipelines.enabled -%}
            {%   set _ = keys.insert(0, pipelines_api_key) -%}
            {% endif -%}
            {{ keys | join(';') }}
      ansible.builtin.include_tasks: tasks/k8s/secrets/generic.yml

    - name: Install Open WebUI Helm chart
      vars:
        repo_name: open-webui
        repo_url: "{{ openwebui_chart_repo_url }}"
        chart_ref: open-webui
        chart_ver: "{{ openwebui_chart_version if
          openwebui_chart_repo_url is match('^http') else omit }}"
        release: "{{ openwebui_release_name }}"
        release_ns: "{{ openwebui_namespace }}"
        values: "{{ openwebui_chart_values }}"

        extras: # adopt extra resources into Helm release
          - cert-manager.io/v1 Certificate {{ openwebui_secrets['ingress']  }}
          - cert-manager.io/v1 Certificate {{ openwebui_secrets['database'] }}
          - v1 Secret {{ openwebui_secrets['env-vars'] }}

        # pulling custom image from
        # Harbor could take a while
        wait_timeout: 600
        task_timeout: 900
      ansible.builtin.include_tasks: tasks/helm/helmfile.yml

# https://openwebui.fourteeners.local/docs
- name: Configure Open WebUI installation
  tags:
    - configure
    - knowledge
  hosts: localhost
  vars_files:
    - vars/openwebui.yml
    - vars/ollama.yml
  vars:
    vars_file: vars/ollama.{{ use_ollama_chart_by }}.yml
    api_base: https://{{ openwebui_fqdns | first }}/api
    group_name: Family
    knowledge_name: Accounts
    model_name: Accounts
  pre_tasks:
    - name: Include {{ vars_file }}
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/include_vars_module.html
      ansible.builtin.include_vars: "{{ vars_file }}"

    - name: Wait until Open WebUI is ready
      # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/uri_module.html
      ansible.builtin.uri:
        url: "{{ api_base }}/version"
        return_content: true
      # https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_loops.html#retrying-a-task-until-a-condition-is-met
      register: ui_version
      retries: 20
      delay: 3
  tasks:
    - name: Authenticate as the admin user
      ansible.builtin.uri:
        method: POST
        url: "{{ api_base }}/v1/auths/signin"
        body_format: json
        body:
          email: "{{ openwebui_admin_user.email }}"
          password: "{{ openwebui_admin_user.password }}"
        status_code: [200, 400]
        return_content: true
      register: admin_signin

    - name: Create Open WebUI admin user
      when: admin_signin.status != 200
      block:
        # first user created has admin rights:
        # https://docs.openwebui.com/features/workspace/roles
        - name: Create Open WebUI admin user
          ansible.builtin.uri:
            method: POST
            url: "{{ api_base }}/v1/auths/signup"
            body_format: json
            body: "{{ openwebui_admin_user }}"
            return_content: true
          register: admin_signup
          changed_when: true

        - name: Set user default chat model
          vars:
            token: "{{ admin_signup.json.token }}"
          ansible.builtin.uri:
            method: POST
            url: "{{ api_base }}/v1/users/user/settings/update"
            headers:
              Authorization: Bearer {{ token }}
            body_format: json
            body:
              ui:
                version: "{{ ui_version.json.version }}"
                system: "{{ openwebui_system_prompt }}"
                models: "{{ [ollama_models | first] }}"
                params: {}
          retries: 3
          delay: 3

    - name: Set admin auth_headers fact
      vars:
        user: >-
          {{ admin_signup.json if admin_signup      is defined and
                                  admin_signup.json is defined else
             admin_signin.json }}
      ansible.builtin.set_fact:
        auth_headers:
          Authorization: Bearer {{ user.token }}
        admin_token: "{{ user.token }}"
        admin_user: "{{ {
          'id':    user.id,
          'name':  user.name,
          'email': user.email,
          'role':  user.role,
          'profile_image_url': user.profile_image_url,
          } }}"
        # use different (all caps) name for fact to prevent
        # errors due to facts having higher precedence than
        # vars with the same name at the play level
        API_BASE: "{{ api_base }}"

    - name: Get Open WebUI user groups
      ansible.builtin.uri:
        url: "{{ api_base }}/v1/groups/"
        headers: "{{ auth_headers }}"
        return_content: true
      register: list_groups

    - name: Create Erhhung's Family group
      vars:
        family: "{{ list_groups.json | selectattr('name', '==', group_name) }}"
      when: family is falsy
      block:
        - name: Create the "Family" group
          ansible.builtin.uri:
            method: POST
            url: "{{ api_base }}/v1/groups/create"
            headers: "{{ auth_headers }}"
            body_format: json
            body:
              name: "{{ group_name }}"
              description: Erhhung's family
            return_content: true
          register: create_group
          changed_when: true

        - name: Add admin to Family group
          vars:
            group: "{{ create_group.json }}"
          ansible.builtin.uri:
            method: POST
            url: "{{ api_base }}/v1/groups/id/{{ group.id }}/update"
            headers: "{{ auth_headers }}"
            body_format: json
            body:
              # name and description must
              # be specified at a minimum
              name: "{{ group.name }}"
              description: "{{ group.description }}"
              user_ids: "{{ [admin_user.id] }}"
          changed_when: true

    - name: Set family_group_id fact
      ansible.builtin.set_fact:
        family_group_id: >-
          {{ create_group.json.id if create_group      is defined and
                                     create_group.json is defined else
              list_groups.json | selectattr('name', '==', group_name)
                               |        map(attribute='id') | first }}

    - name: Get Open WebUI user memories
      ansible.builtin.uri:
        url: "{{ api_base }}/v1/memories/"
        headers: "{{ auth_headers }}"
        return_content: true
      register: list_memories

    - name: Populate Erhhung's memories
      vars:
        current: "{{ list_memories.json | selectattr('user_id', '==', admin_user.id) }}"
      when: current is falsy
      block:
        - name: Read encrypted memories.yaml
          vars:
            mem_file: files/openwebui/memories.yaml.gz.age
          # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html
          ansible.builtin.shell: |
            age_file="{{ mem_file }}"
            tmp_file="/tmp/$(basename "$age_file")"
            yml_file="${tmp_file/%.gz.age/}"

            cp -f "$age_file" /tmp
            ./gzage.sh "$tmp_file"
            cat   "$yml_file"
            rm -f "$yml_file"
          register: memories_yaml
          changed_when: false

        - name: Add new content to memories
          vars:
            memories: "{{ memories_yaml.stdout | from_yaml }}"
          ansible.builtin.uri:
            method: POST
            url: "{{ api_base }}/v1/memories/add"
            headers: "{{ auth_headers }}"
            body_format: json
            body:
              content: "{{ item.content }}"
          loop: "{{ memories }}"
          loop_control:
            label: "{{ item.title }}"
          changed_when: true

    - name: Get Open WebUI knowledge bases
      ansible.builtin.uri:
        # this API does not populate
        # the knowledge's files list
        url: "{{ api_base }}/v1/knowledge/"
        headers: "{{ auth_headers }}"
        return_content: true
      register: list_knowledge

    - name: Get Accounts knowledge & files
      vars:
        knowledge: "{{ list_knowledge.json['items'] |
          selectattr('name', '==', knowledge_name) }}"
      when: knowledge is truthy
      block:
        - name: Get Accounts knowledge base
          ansible.builtin.uri:
            url: "{{ api_base }}/v1/knowledge/{{ knowledge[0].id }}"
            headers: "{{ auth_headers }}"
            return_content: true
          register: get_knowledge

        - name: Get Accounts knowledge files
          vars:
            auth_token: "{{ admin_token }}"
            knowledge_id: "{{ knowledge[0].id }}"
          ansible.builtin.include_tasks: tasks/openwebui/files.yml
          # sets knowledge_files fact

    - name: Create Accounts knowledge base
      vars:
        knowledge: "{{ list_knowledge.json['items'] |
          selectattr('name', '==', knowledge_name) }}"
      ansible.builtin.uri:
        method: POST
        url: "{{ api_base }}/v1/knowledge/create"
        headers: "{{ auth_headers }}"
        body_format: json
        body:
          name: "{{ knowledge_name }}"
          description: Confidential information and
            notable events about various accounts
          access_control:
            read:
              group_ids: "{{ [family_group_id] }}"
            write:
              user_ids: "{{ [admin_user.id] }}"
        return_content: true
      when: knowledge is falsy
      register: create_knowledge
      changed_when: true

    - name: Set accounts_knowledge fact
      ansible.builtin.set_fact:
        accounts_knowledge: |
          {{ get_knowledge.json | ansible.builtin.combine({'files': knowledge_files})
          if get_knowledge.json is defined else create_knowledge.json }}

    - name: Get Open WebUI custom models
      ansible.builtin.uri:
        url: "{{ api_base }}/v1/models/list"
        headers: "{{ auth_headers }}"
        return_content: true
      register: list_models

    - name: Create Accounts custom model
      vars:
        model: "{{ list_models.json['items'] |
          selectattr('name', '==', model_name) }}"
        base_model: "{{ ollama_models | select('search', '^qwen3') | first }}"
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_lookup.html
        image_data: "{{ lookup('ansible.builtin.file', 'images/assistant.png') }}"
        image_url: data:image/png;base64,{{ image_data | b64encode }}
        knowledge: |
          {% set know = accounts_knowledge %}
          {% set _ = know.update({
               'type': 'collection',
               'user':  admin_user,
             })   %}
          {{ know }}
      ansible.builtin.uri:
        method: POST
        url: "{{ api_base }}/v1/models/create"
        headers: "{{ auth_headers }}"
        body_format: json
        body:
          id: accounts
          name: "{{ model_name }}"
          meta:
            description: Qwen3 base model RAG-enhanced with Accounts knowledge base
            tags:
              - name: private
            profile_image_url: "{{ image_url }}"
            capabilities:
              citations: true
              file_upload: true
              web_search: false
              code_interpreter: false
              image_generation: false
              vision: false
            knowledge: "{{ [knowledge] }}"
          base_model_id: "{{ base_model }}"
          params:
            system: >-
              You are a personal assistant that has intimate knowledge of all
              personal information entrusted to you in the attached knowledge
              base. When you answer questions, consult the personal knowledge
              base before applying additional general knowledge.
          access_control:
            read:
              group_ids: "{{ [family_group_id] }}"
            write:
              user_ids: "{{ [admin_user.id] }}"
        return_content: true
      register: create_model
      when: model is falsy
      changed_when: true

    - name: Set accounts_model fact
      vars:
        model: "{{ list_models.json['items'] |
          selectattr('name', '==', model_name) }}"
      ansible.builtin.set_fact:
        accounts_model: |
          {{ model | first if model is truthy else create_model.json }}

# NOTE: this play takes a long time to run because it loops through hundreds of files
# and, for each, checks with Open WebUI whether it exists or has changed, and uploads
# and processes the file if necessary; thus, this play will only run if it's the only
# play specified to run and the "knowledge" tag is also specified on the command line

- name: Update Accounts knowledge
  # must run after previous play to
  # get auth token and knowledge ID
  tags: knowledge
  hosts: cosmos
  vars_files:
    # needed by tasks/openwebui/upload.yml
    - vars/kubernetes.yml
    - vars/openwebui.yml
  vars:
    facts: "{{ hostvars['localhost'] }}"
    # PLAYBOOKS is extra var passed by play.sh or by AWX workflow survey;
    # strip numbering and padding added for showing as ordered list in UI
    # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/regex_replace_filter.html
    playbooks:
      "{{ PLAYBOOKS | map('ansible.builtin.regex_replace', '\\s*(\\d+\\. )?','') if
      PLAYBOOKS is defined and PLAYBOOKS is sequence and PLAYBOOKS is not string else [] }}"
    # this var can be set on the command line
    # to limit the number of files to process
    limit: 0
  pre_tasks:
    - name: Upload files or skip upload?
      ansible.builtin.set_fact:
        do_upload: "{{ playbooks == ['openwebui'] and 'knowledge' in ansible_run_tags }}"
      # this var can be set directly on
      # the command line to skip upload
      when: do_upload is undefined

    - name: Prepare for file uploads
      when: do_upload
      block:
        - name: Gather facts about user_dir
          # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/setup_module.html
          ansible.builtin.setup:
            gather_subset: user_dir

        - name: Ensure DNS resolution works
          ansible.builtin.include_tasks: tasks/hosts/dns.yml

        - name: Find ~/accounts/*.txt files
          # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/find_module.html
          ansible.builtin.find:
            paths: ~/accounts/
            follow: true
            recurse: true
            patterns: "*.txt"
            get_checksum: true
          register: find_files

        - name: Reset loop_changes fact
          ansible.builtin.set_fact:
            loop_changes: []
  tasks:
    # order by recently modified
    - name: Add file to knowledge
      vars:
        auth_token: "{{ facts['admin_token'] }}"
        knowledge: "{{ facts['accounts_knowledge'] }}"
        accts_dir: "{{ ansible_user_dir }}/accounts/"
        # https://docs.ansible.com/ansible/latest/collections/ansible/builtin/strftime_filter.html
        acct_files: |
          {% set files  = [] %}
          {# use namespace() to create a scoped object #}
          {# https://jinja.palletsprojects.com/en/stable/templates#assignments #}
          {% set ns = namespace(
               sorted=find_files.files | sort(attribute='mtime', reverse=true)) %}
          {% if limit|int > 0 and limit|int < ns.sorted | length %}
          {%   set ns.sorted = ns.sorted[:limit|int] %}
          {% endif %}
          {% set total  = ns.sorted | length %}
          {% set n      = accts_dir | length %}
          {% for i  in range(total)    %}
          {%   set file = ns.sorted[i] %}
          {%   set _    = files.append({
                 'label':    (i + 1) ~'/'~ total ~'|'~ file.path[n:],
                 'index':     i + 1,
                 'total':     total,
                 'abs_path':  file.path,
                 'rel_path':  file.path[n:],
                 'sha1':      file.checksum,
                 'size':      file.size,
                 'mtime':    '%Y-%m-%d %H:%M:%S' | strftime(file.mtime),
               })   %}
          {% endfor %}
          {{ files  }}
        file_info: "{{ item }}"
      ansible.builtin.include_tasks: tasks/openwebui/upload.yml
      loop: "{{ acct_files }}"
      loop_control:
        label: "{{ item.label }}"
      register: upload_files
      when: do_upload

    - name: Were any files changed?
      ansible.builtin.set_fact:
        files_changed: |
          {{ do_upload and loop_changes is any }}
      # this allows forcing the next task
      # to run if this var is set to true
      # directly on the command line
      when: files_changed is undefined

    # not sure if this step is needed so that the custom model,
    # which was created initially with an empty knowledge, gets
    # populated with new file references from updated knowledge:
    # https://github.com/open-webui/open-webui/issues/16318
    - name: Update Accounts model
      delegate_to: localhost
      when: files_changed
      vars:
        model: "{{ facts['accounts_model'] }}"
        knowledge_id: "{{ model.meta.knowledge[0].id }}"
        auth_headers: "{{ facts['auth_headers'] }}"
        admin_user: "{{ facts['admin_user'] }}"
        api_base: "{{ facts['API_BASE'] }}/v1"
      block:
        - name: Refresh Accounts knowledge
          ansible.builtin.uri:
            url: "{{ api_base }}/knowledge/{{ knowledge_id }}"
            headers: "{{ auth_headers }}"
            return_content: true
          register: new_knowledge

        - name: Update Accounts model
          vars:
            knowledge: |
              {% set know = new_knowledge.json %}
              {% set _ = know.update({
                  'type': 'collection',
                  'user':  admin_user,
                 })   %}
              {{ know }}
          ansible.builtin.uri:
            method: POST
            url: "{{ api_base }}/models/model/update?id=accounts"
            headers: "{{ auth_headers }}"
            body_format: json
            body: |
              {% set _ = model.meta.update({
                   'knowledge': [knowledge]
                 }) %}
              {{ model }}
          changed_when: true
